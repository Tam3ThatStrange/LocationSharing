<!DOCTYPE html>
<html>
<head>
    <title>Live Location Share</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <style>
        body { margin: 0; }
        #map { height: 100vh; }
    </style>
</head>
<body>

<div id="map"></div>

<script>
    const socket = io();

    const username = prompt("Enter your username:");
    socket.emit("join", username || "Anonymous");

    const map = L.map('map').setView([0, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    let markers = {};

    navigator.geolocation.watchPosition(position => {
        const { latitude, longitude } = position.coords;

        socket.emit("send-location", { latitude, longitude });

        map.setView([latitude, longitude], 15);
    }, 
    error => alert("Location permission denied"),
    { enableHighAccuracy: true });

    socket.on("update-locations", (users) => {

        for (let id in markers) {
            if (!users[id]) {
                map.removeLayer(markers[id]);
                delete markers[id];
            }
        }

        for (let id in users) {
            const user = users[id];

            if (user.latitude && user.longitude) {
                if (!markers[id]) {
                    markers[id] = L.marker([user.latitude, user.longitude])
                        .addTo(map)
                        .bindPopup(user.username);
                } else {
                    markers[id]
                        .setLatLng([user.latitude, user.longitude])
                        .setPopupContent(user.username);
                }
            }
        }
    });
</script>

</body>
</html>
