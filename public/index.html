<!DOCTYPE html>
<html>
<head>
    <title>Live Location + Chat</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <style>
        body { margin: 0; display: flex; }
        #map { height: 100vh; width: 70%; }

        #chat {
            width: 30%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #ccc;
            font-family: Arial;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        #input-area {
            display: flex;
        }

        #message-input {
            flex: 1;
            padding: 10px;
            border: none;
            border-top: 1px solid #ccc;
        }

        button {
            padding: 10px;
            border: none;
            background: #007bff;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        .message {
            margin-bottom: 8px;
        }

        .username {
            font-weight: bold;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div id="chat">
    <div id="messages"></div>
    <div id="input-area">
        <input id="message-input" placeholder="Type a message..." />
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
    const socket = io();

    const username = prompt("Enter your username:");
    socket.emit("join", username || "Anonymous");

    const map = L.map('map').setView([0, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    let markers = {};

    navigator.geolocation.watchPosition(position => {
        const { latitude, longitude } = position.coords;
        socket.emit("send-location", { latitude, longitude });
        map.setView([latitude, longitude], 15);
    }, 
    error => alert("Location permission denied"),
    { enableHighAccuracy: true });

    socket.on("update-locations", (users) => {
        for (let id in markers) {
            if (!users[id]) {
                map.removeLayer(markers[id]);
                delete markers[id];
            }
        }

        for (let id in users) {
            const user = users[id];
            if (user.latitude && user.longitude) {
                if (!markers[id]) {
                    markers[id] = L.marker([user.latitude, user.longitude])
                        .addTo(map)
                        .bindPopup(user.username);
                } else {
                    markers[id]
                        .setLatLng([user.latitude, user.longitude])
                        .setPopupContent(user.username);
                }
            }
        }
    });

    // ðŸ’¬ CHAT
    function sendMessage() {
        const input = document.getElementById("message-input");
        const message = input.value;
        if (message.trim() !== "") {
            socket.emit("chat-message", message);
            input.value = "";
        }
    }

    socket.on("chat-message", (data) => {
        const messages = document.getElementById("messages");
        const div = document.createElement("div");
        div.classList.add("message");
        div.innerHTML = `<span class="username">${data.username}:</span> ${data.message}`;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
    });

    document.getElementById("message-input")
        .addEventListener("keypress", function(e) {
            if (e.key === "Enter") sendMessage();
        });

</script>

</body>
</html>
